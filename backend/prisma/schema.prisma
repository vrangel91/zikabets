// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  cpf       String   @unique
  password  String
  balance   Float    @default(0)
  role      String   @default("USER") // USER or ADMIN
  adminPermissions String? // JSON string com permissões: ["dashboard", "teams", "players", "games", "odds", "close-game", "championship", "users"]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bets         Bet[]
  transactions Transaction[]

  @@map("users")
}

model Team {
  id        String   @id @default(cuid())
  name      String   @unique
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  players      Player[]
  gamesAsTeamA Game[]   @relation("TeamA")
  gamesAsTeamB Game[]   @relation("TeamB")

  @@map("teams")
}

model Player {
  id                  String   @id @default(cuid())
  name                String
  teamId              String
  pot                 Int? // Pote do jogador (1, 2, 3, etc.)
  topKillerDefaultOdds Float? // Odds padrão para Top Killer
  topDeadDefaultOdds  Float? // Odds padrão para Top Dead
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, name])
  @@map("players")
}

model Game {
  id           String   @id @default(cuid())
  teamAId      String
  teamBId      String
  startTime    DateTime
  status       String   @default("SCHEDULED") // SCHEDULED, LIVE, CLOSED
  winnerId     String? // ID do time vencedor quando fechado
  duration     Int? // Duração em minutos quando fechado
  topKiller    String? // Nome do jogador com mais kills quando fechado
  lowestDeaths String? // ID do jogador com menos mortes quando fechado
  roshanTotal  Int? // Total de Roshans feitos na partida quando fechado
  firstRoshanTeamId String? // ID do time que fez o primeiro roshan quando fechado
  firstFFTeamId String? // ID do time que deu !ff quando fechado
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  teamA Team @relation("TeamA", fields: [teamAId], references: [id])
  teamB Team @relation("TeamB", fields: [teamBId], references: [id])

  bets         Bet[]
  odds         GameOdds?
  transactions Transaction[]

  @@map("games")
}

model GameOdds {
  id               String   @id @default(cuid())
  gameId           String   @unique
  teamAOdds        Float    @default(1.5)
  teamBOdds        Float    @default(1.5)
  // Duração em faixas (15-20, 20-25, 25-30, 30-35, 35-40, 40-45, 50+) - armazenado como JSON string
  durationOdds     String? // { "15-20": 2.0, "20-25": 1.8, "25-30": 1.5, "30-35": 1.3, "35-40": 1.2, "40-45": 1.1, "50+": 1.0 }
  topKillerOdds    Float    @default(2.0)
  lowestDeathsOdds Float    @default(2.0)
  // Odds por jogador - armazenado como JSON string { "playerId": odds }
  topKillerPlayerOdds String? // { "playerId1": 2.5, "playerId2": 2.0, ... }
  lowestDeathsPlayerOdds String? // { "playerId1": 2.5, "playerId2": 2.0, ... }
  // Total de Roshan (Over/Under) - armazenado como JSON string { "over_2.5": 1.8, "under_2.5": 1.9, "over_3.5": 2.0, "under_3.5": 1.7 }
  roshanTotalOdds  String? // { "over_2.5": 1.8, "under_2.5": 1.9, ... }
  // Primeiro Roshan - armazenado como JSON string { "teamA": 1.5, "teamB": 1.5 }
  firstRoshanOdds  String? // { "teamA": 1.5, "teamB": 1.5 }
  // Primeiro !ff - armazenado como JSON string { "teamA": 1.5, "teamB": 1.5 }
  firstFFOdds      String? // { "teamA": 1.5, "teamB": 1.5 }
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@map("game_odds")
}

model Bet {
  id           String   @id @default(cuid())
  userId       String
  gameId       String
  type         String // WINNER, DURATION, TOP_KILLER, LOWEST_DEATHS, ROSHAN_TOTAL, FIRST_ROSHAN, FIRST_FF
  selection    String // ID do time, faixa de duração, nome do jogador, ou opção (over_2.5, under_2.5, etc.)
  amount       Float
  odds         Float
  status       String   @default("PENDING") // PENDING, WON, LOST
  isMultiple   Boolean  @default(false)
  multipleId   String? // ID para agrupar apostas múltiplas
  returnAmount Float? // Valor retornado quando ganhou
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  game Game @relation(fields: [gameId], references: [id])

  @@map("bets")
}

model Transaction {
  id          String   @id @default(cuid())
  userId      String
  gameId      String?
  type        String // DEPOSIT, WITHDRAWAL, BET, WIN
  amount      Float
  description String?
  createdAt   DateTime @default(now())

  user User  @relation(fields: [userId], references: [id])
  game Game? @relation(fields: [gameId], references: [id])

  @@map("transactions")
}

model PixTransaction {
  id                    String   @id @default(cuid())
  userId                String
  amount                Float
  qrCode                String
  qrCodeBase64          String?
  status                String   @default("PENDING") // PENDING, APPROVED, REJECTED
  pixCode               String? // Código PIX copiável
  transactionId        String? // ID da transação relacionada
  mercadoPagoPaymentId  String? // ID do pagamento no Mercado Pago
  mercadoPagoStatus     String? // Status do pagamento no Mercado Pago
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("pix_transactions")
}

model Championship {
  id          String   @id @default(cuid())
  name        String
  description String?
  status      String   @default("DRAFT") // DRAFT, ACTIVE, FINISHED
  startPhase  String   @default("GROUPS") // GROUPS, ROUND_OF_16, QUARTER_FINALS, SEMI_FINALS, FINAL
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  groups      ChampionshipGroup[]
  config      ChampionshipConfig?
  matches      ChampionshipMatch[]

  @@map("championships")
}

model ChampionshipConfig {
  id            String   @id @default(cuid())
  championshipId String  @unique
  hasRoundOf16  Boolean  @default(false)
  hasQuarterFinals Boolean @default(false)
  hasSemiFinals Boolean  @default(false)
  hasFinal      Boolean  @default(true)
  startPhase    String   @default("GROUPS") // GROUPS, ROUND_OF_16, QUARTER_FINALS, SEMI_FINALS, FINAL
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  championship Championship @relation(fields: [championshipId], references: [id], onDelete: Cascade)

  @@map("championship_configs")
}

model ChampionshipGroup {
  id            String   @id @default(cuid())
  championshipId String
  name          String   // A, B, C, D, etc.
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  championship Championship @relation(fields: [championshipId], references: [id], onDelete: Cascade)
  teams        ChampionshipTeam[]

  @@unique([championshipId, name])
  @@map("championship_groups")
}

model ChampionshipTeam {
  id            String   @id @default(cuid())
  groupId       String
  name          String
  logo          String?
  points        Int      @default(0)
  wins          Int      @default(0)
  losses        Int      @default(0)
  advanced      Boolean  @default(false) // Se avançou para próxima fase
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  group         ChampionshipGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  players       ChampionshipPlayer[]
  matchesAsTeamA ChampionshipMatch[] @relation("ChampionshipTeamA")
  matchesAsTeamB ChampionshipMatch[] @relation("ChampionshipTeamB")

  @@map("championship_teams")
}

model ChampionshipPlayer {
  id            String   @id @default(cuid())
  teamId        String
  name          String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  team ChampionshipTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, name])
  @@map("championship_players")
}

model ChampionshipMatch {
  id            String   @id @default(cuid())
  championshipId String
  phase         String   // GROUPS, ROUND_OF_16, QUARTER_FINALS, SEMI_FINALS, FINAL
  teamAId       String?
  teamBId       String?
  scoreA        Int?
  scoreB        Int?
  status        String   @default("SCHEDULED") // SCHEDULED, LIVE, FINISHED
  matchDate     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  championship Championship @relation(fields: [championshipId], references: [id], onDelete: Cascade)
  teamA        ChampionshipTeam? @relation("ChampionshipTeamA", fields: [teamAId], references: [id])
  teamB        ChampionshipTeam? @relation("ChampionshipTeamB", fields: [teamBId], references: [id])

  @@map("championship_matches")
}
